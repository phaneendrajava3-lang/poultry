<%@ page contentType="text/html; charset=UTF-8" pageEncoding="UTF-8" %>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions" %>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>Poultry Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // Define contextPath for use in JS
    var contextPath = '${pageContext.request.contextPath}';
  </script>
</head>
<body style="background:#f6f8fa; margin:0; padding:0;">
<%@ include file="nav.jsp" %>
<div class="main-content">
<div class="container py-4">

<div class="card mb-3" style="border:none;">
  <div class="card-header d-flex align-items-center justify-content-between">
    <div>
      <strong>Expenditure & Returns</strong>
      <span class="text-muted small ms-2">Use filters below</span>
    </div>
    <a class="btn btn-success fw-bold shadow"
       href="${pageContext.request.contextPath}/report"
       style="background: linear-gradient(90deg,#28a745 0%,#218838 100%);
              color:#fff;border:none;box-shadow:0 2px 8px rgba(40,167,69,0.18);">
      ðŸ“Š Generate Report
    </a>
  </div>


  <form id="dashboardFilterForm" class="row g-2 align-items-end mb-3" method="get" action="${pageContext.request.contextPath}/dashboard">

    <!-- Month Selection -->
    <div class="col-auto" style="padding-left:500px;">
      <label for="filterMonth" class="form-label mb-0">Month</label>
      <select id="filterMonth" name="month" class="form-select" onchange="document.getElementById('dashboardFilterForm').submit();">
        <c:forEach var="i" begin="1" end="12">
          <option value="${i}" <c:if test="${i == selectedMonth}">selected</c:if>>
            <c:choose>
              <c:when test="${i == 1}">Jan</c:when>
              <c:when test="${i == 2}">Feb</c:when>
              <c:when test="${i == 3}">Mar</c:when>
              <c:when test="${i == 4}">Apr</c:when>
              <c:when test="${i == 5}">May</c:when>
              <c:when test="${i == 6}">Jun</c:when>
              <c:when test="${i == 7}">Jul</c:when>
              <c:when test="${i == 8}">Aug</c:when>
              <c:when test="${i == 9}">Sep</c:when>
              <c:when test="${i == 10}">Oct</c:when>
              <c:when test="${i == 11}">Nov</c:when>
              <c:otherwise>Dec</c:otherwise>
            </c:choose>
          </option>
        </c:forEach>
      </select>
    </div>

    <!-- Year Selection -->
    <div class="col-auto">
      <label for="filterYear" class="form-label mb-0">Year</label>
      <select id="filterYear" name="year" class="form-select" onchange="document.getElementById('dashboardFilterForm').submit();">
        <c:forEach var="y" begin="2025" end="2030">
          <option value="${y}" <c:if test="${y == selectedYear}">selected</c:if>>${y}</option>
        </c:forEach>
      </select>
    </div>

  </form>


  <div class="row g-3 mb-4" style="align-items: centre;">
    <div class="col-md-2">
      <div class="card shadow-sm p-3 text-center" style="background:#e3f2fd;min-height:110px;">
        <div class="text-muted">Total Customers</div>
        <div class="fs-4" style="color:#1976d2;">${totalCustomers}</div>
      </div>
    </div>
    <div class="col-md-2">
      <div class="card shadow-sm p-3 text-center" style="background:#e8f5e9;min-height:110px;">
        <div class="text-muted">Total Drivers</div>
        <div class="fs-4" style="color:#388e3c;">${totalDrivers}</div>
      </div>
    </div>
    <div class="col-md-2">
      <div class="card shadow-sm p-3 text-center" style="background:#fff3e0;min-height:110px;">
        <div class="text-muted">Vans in Service</div>
        <div class="fs-4" style="color:#f57c00;">${totalVans}</div>
      </div>
    </div>
    <div class="col-md-2">
      <div class="card shadow-sm p-3 text-center" style="background:#fce4ec;min-height:110px;">
        <div class="text-muted">Trips This Month</div>
        <div class="fs-4" style="color:#d81b60;">${tripsThisMonth}</div>
      </div>
    </div>
    <div class="col-md-2">
      <div class="card shadow-sm p-3 text-center" style="background:#ede7f6;min-height:110px;">
        <div class="text-muted">Entries This Month</div>
        <div class="fs-4" style="color:#512da8;">${entriesThisMonth}</div>
      </div>
    </div>
    <div class="col-md-2">
      <div class="card shadow-sm p-3 text-center" style="background:#fffde7;min-height:110px;">
        <div class="text-muted">Expenses</div>
        <div class="fs-4" style="color:#fbc02d;">â‚¹ ${expenses}</div>
      </div>
    </div>
    <div class="col-md-2">
      <div class="card shadow-sm p-3 text-center" style="background:#fbe9e7;min-height:110px;">
        <div class="text-muted">Sales</div>
        <div class="fs-4" style="color:#e64a19;font-size:2rem;">â‚¹ ${entriesAmount}</div>
      </div>
    </div>
    <div class="col-md-2">
      <div class="card shadow-sm p-3 text-center" style="background:#e0f7fa;min-height:110px;">
        <div class="text-muted">Amount Received</div>
        <div class="fs-4" style="color:#00838f;">â‚¹ ${amountReceived}</div>
      </div>
    </div>
    <div class="col-md-2">
      <div class="card shadow-sm p-3 text-center" style="background:#f9fbe7;min-height:110px;">
        <div class="text-muted">Fuel Expenses</div>
        <div class="fs-4" style="color:#afb42b;">â‚¹ ${fuelCost}</div>
      </div>
    </div>
    <div class="col-md-2">
      <div class="card shadow-sm p-3 text-center" style="background:#f3e5f5;min-height:110px;">
        <div class="text-muted">Dead Chicks</div>
        <div class="fs-4" style="color:#6a1b9a;">${deadChicks}</div>
      </div>
    </div>
  </div>

  <div class="row g-3">
    <div class="col-md-6">
      <div class="card p-3 shadow-sm">
        <h6>Monthly Financial Overview</h6>
        <canvas id="financeChart"></canvas>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card p-3 shadow-sm">
        <h6>Monthly Trends (Yearly Line Chart)</h6>
        <canvas id="monthlyTrendsChart"></canvas>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card p-3 shadow-sm">
        <h6>Dead Chicks & Birds Count</h6>
        <canvas id="deadTripsChart" style="max-width: 350px; max-height: 220px;"></canvas>
      </div>
    </div>
  </div>

</div>
</div>
</div>

<script>
	
	document.addEventListener("DOMContentLoaded", function() {
	    const months = document.querySelectorAll("#filterMonth option");
	    months.forEach(opt => console.log("Month option:", opt.value, opt.text));

	    const years = document.querySelectorAll("#filterYear option");
	    years.forEach(opt => console.log("Year option:", opt.value));
	  });
	  
  // Helper to update chart data
  function updateCharts(entriesAmount, amountReceived, fuelCost, deadChicks, birdsCount) {
    // Destroy existing charts if they exist
    if (window.financeChartInstance) window.financeChartInstance.destroy();
    if (window.deadTripsChartInstance) window.deadTripsChartInstance.destroy();

    // Dead Chicks & Birds Count Bar Chart
    window.deadTripsChartInstance = new Chart(document.getElementById('deadTripsChart'), {
      type: 'bar',
      data: {
        labels: ['Dead Chicks', 'Birds Count'],
        datasets: [{
          label: 'Count',
          data: [deadChicks, birdsCount],
          backgroundColor: ['#dc3545', '#0d6efd']
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true } }
      }
    });
  }

  // Initial chart render with server values
  updateCharts(
    ${entriesAmount},
    ${amountReceived},
    ${balanceAmount},
    ${deadChicks},
    ${birdsCount}
  );

  // Fetch actual monthly trends data from backend if available
  const monthlyLabels = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
  const monthlyTrendsExpenses = [
    <c:forEach var="m" begin="0" end="11">${monthlyTrendsExpenses[m] != null ? monthlyTrendsExpenses[m] : 0}<c:if test="${m != 11}">,</c:if></c:forEach>
  ];
  const monthlyTrendsSale = [
    <c:forEach var="m" begin="0" end="11">${monthlyTrendsSale[m] != null ? monthlyTrendsSale[m] : 0}<c:if test="${m != 11}">,</c:if></c:forEach>
  ];
  const monthlyTrendsReceived = [
    <c:forEach var="m" begin="0" end="11">${monthlyTrendsReceived[m] != null ? monthlyTrendsReceived[m] : 0}<c:if test="${m != 11}">,</c:if></c:forEach>
  ];

  new Chart(document.getElementById('monthlyTrendsChart'), {
    type: 'bar',
    data: {
      labels: monthlyLabels,
      datasets: [
        {
          label: 'Expenses',
          data: monthlyTrendsExpenses,
          backgroundColor: '#dc3545'
        },
        {
          label: 'Sales',
          data: monthlyTrendsSale,
          backgroundColor: '#0d6efd'
        },
        {
          label: 'Received Amount',
          data: monthlyTrendsReceived,
          backgroundColor: '#198754'
        }
      ]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: true } },
      scales: {
        x: { stacked: false },
        y: { beginAtZero: true, stacked: false }
      }
    }
  });

  // Monthly Financial Overview - Day wise line chart
  const daysInMonth = new Date(${selectedYear}, ${selectedMonth}, 0).getDate();
  const dayLabels = Array.from({length: daysInMonth}, (_, i) => (i+1).toString());
  const dayWiseExpenses = [
    <c:forEach var="d" begin="0" end="${fn:length(dayWiseExpenses) > 0 ? fn:length(dayWiseExpenses)-1 : 0}">${dayWiseExpenses[d]}<c:if test="${d != (fn:length(dayWiseExpenses) > 0 ? fn:length(dayWiseExpenses)-1 : 0)}">,</c:if></c:forEach>
  ];
  const dayWiseSales = [
    <c:forEach var="d" begin="0" end="${fn:length(dayWiseSales) > 0 ? fn:length(dayWiseSales)-1 : 0}">${dayWiseSales[d]}<c:if test="${d != (fn:length(dayWiseSales) > 0 ? fn:length(dayWiseSales)-1 : 0)}">,</c:if></c:forEach>
  ];
  const dayWiseReceived = [
    <c:forEach var="d" begin="0" end="${fn:length(dayWiseReceived) > 0 ? fn:length(dayWiseReceived)-1 : 0}">${dayWiseReceived[d]}<c:if test="${d != (fn:length(dayWiseReceived) > 0 ? fn:length(dayWiseReceived)-1 : 0)}">,</c:if></c:forEach>
  ];

  new Chart(document.getElementById('financeChart'), {
    type: 'bar',
    data: {
      labels: dayLabels,
      datasets: [
        {
          label: 'Expenses',
          data: dayWiseExpenses,
          borderColor: '#dc3545',
          backgroundColor: '#ff4d4f', // bright red
          fill: false,
          tension: 0.4
        },
        {
          label: 'Sales',
          data: dayWiseSales,
          borderColor: '#0d6efd',
          backgroundColor: '#1d7fff', // bright blue
          fill: false,
          tension: 0.4
        },
        {
          label: 'Amount Received',
          data: dayWiseReceived,
          borderColor: '#198754',
          backgroundColor: '#28a745', // bright green
          fill: false,
          tension: 0.4
        }
      ]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: true }
      },
      scales: {
        y: { beginAtZero: true }
      }
    }
  });


  document.getElementById('dashboardFilterForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const month = document.getElementById('filterMonth').value;
    const year = document.getElementById('filterYear').value;
    // Fetch new data via AJAX and update charts without reloading
    fetch('${contextPath}/dashboard?month=${month}&year=${year}&ajax=1')
      .then(res => res.json())
      .then(data => {
        // Update number boards
        document.querySelector('.fs-4:nth-child(1)').textContent = data.totalCustomers;
        document.querySelector('.fs-4:nth-child(2)').textContent = data.totalDrivers;
        document.querySelector('.fs-4:nth-child(3)').textContent = data.totalVans;
        document.querySelector('.fs-4:nth-child(4)').textContent = data.tripsThisMonth;
        document.querySelector('.fs-4:nth-child(5)').textContent = data.entriesThisMonth;
        document.querySelector('.fs-4:nth-child(6)').textContent = 'â‚¹ ' + data.entriesAmount;
        document.querySelector('.fs-4:nth-child(7)').textContent = 'â‚¹ ' + data.amountReceived;
        document.querySelector('.fs-4:nth-child(8)').textContent = 'â‚¹ ' + data.fuelCost;
        document.querySelector('.fs-4:nth-child(9)').textContent = data.deadChicks;
        // Update charts
        updateCharts(
          data.entriesAmount,
          data.amountReceived,
          data.fuelCost,
          data.deadChicks,
          data.birdsCount
        );
      })
      .catch(() => window.location.href = '${contextPath}/dashboard?month=${month}&year=${year}');
  });
</script>
</body>
</html>
