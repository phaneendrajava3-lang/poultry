<%@ page contentType="text/html; charset=UTF-8" pageEncoding="UTF-8" %>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%@ taglib prefix="fn" uri="http://java.sun.com/jsp/jstl/functions" %>
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8"/>
  <title>Trip Details</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>
  <style>
    .custom-table-box {
      max-width: 100%;
      width: 100%;
      max-height: 400px;
      min-height: 200px;
      overflow: auto;
      border: 1px solid #dee2e6;
      border-radius: 0.5rem;
      background: #fff;
      margin-bottom: 1rem;
      padding: 0.5rem;
    }
  </style>
</head>
<body class="bg-light">
<%@ include file="nav.jsp" %>
<div class="container mt-4">
  <h2 class="mb-3">Trip Details</h2>
  <form action="${pageContext.request.contextPath}/trip-details/save" method="post" class="card p-4 mb-4 shadow-sm bg-white">
    <div class="row g-3">
      <div class="col-md-2">
        <label class="form-label">Trip Number</label>
        <input type="number" name="tripNumber" id="tripNumberInput" class="form-control" required readonly
          value="<c:out value='${editTripDetails.tripNumber}' default=''/>"/>
      </div>
      <div class="col-md-2">
        <label class="form-label">Driver</label>
        <select name="driver.id" class="form-select" required>
          <option value="">-- Select Driver --</option>
          <c:forEach var="d" items="${drivers}">
            <option value="${d.id}" <c:if test="${not empty editTripDetails && editTripDetails.driver != null && editTripDetails.driver.id == d.id}">selected</c:if>>${d.name}</option>
          </c:forEach>
        </select>
      </div>
      <div class="col-md-2">
        <label class="form-label">Co-Driver</label>
        <select name="codriver.id" class="form-select">
          <option value="">-- Select Co-Driver --</option>
          <c:forEach var="d" items="${drivers}">
            <option value="${d.id}" <c:if test="${not empty editTripDetails && editTripDetails.codriver != null && editTripDetails.codriver.id == d.id}">selected</c:if>>${d.name}</option>
          </c:forEach>
        </select>
      </div>
      <div class="col-md-2">
        <label class="form-label">Van</label>
        <select name="van.id" class="form-select" required>
          <option value="">-- Select Van --</option>
          <c:forEach var="v" items="${vans}">
            <option value="${v.id}" <c:if test="${not empty editTripDetails && editTripDetails.van != null && editTripDetails.van.id == v.id}">selected</c:if>>${v.vehicleNumber}</option>
          </c:forEach>
        </select>
      </div>
      <div class="col-md-2">
        <label class="form-label">Start Date</label>
        <input type="date" name="startDate" class="form-control" required
          value="<c:out value='${editTripDetails.startDate}' default=''/>"/>
      </div>
      <div class="col-md-2">
        <label class="form-label">End Date</label>
        <input type="date" name="endDate" class="form-control" required
          value="<c:out value='${editTripDetails.endDate}' default=''/>"/>
      </div>
      <div class="col-md-2">
        <label class="form-label">Loading Point</label>
        <input type="text" name="loadingPoint" class="form-control"
          value="<c:out value='${editTripDetails.loadingPoint}' default=''/>"/>
      </div>
      <div class="col-md-2">
        <label class="form-label">Fuel Cost</label>
        <input type="number" name="fuelCost" class="form-control" step="0.01"
          value="<c:out value='${editTripDetails.fuelCost}' default=''/>"/>
      </div>
      <div class="col-md-2">
        <label class="form-label">Fuel Bill No.</label>
        <input type="text" name="fuelBillNumber" class="form-control"
          value="<c:out value='${editTripDetails.fuelBillNumber}' default=''/>"/>
      </div>
      <div class="col-md-2">
        <label class="form-label">Dead Chicks</label>
        <input type="number" name="deadChicks" class="form-control"
          value="<c:out value='${editTripDetails.deadChicks}' default=''/>"/>
      </div>
      <div class="col-md-2">
        <label class="form-label">Dead Chicks Weight</label>
        <input type="number" name="deadChicksWeight" class="form-control" step="0.01"
          value="<c:out value='${editTripDetails.deadChicksWeight}' default=''/>"/>
      </div>
      <div class="col-md-2">
        <label class="form-label">Total Chicks Weight</label>
        <input type="number" name="totalChicksWeight" class="form-control" step="0.01"
          value="<c:out value='${editTripDetails.totalChicksWeight}' default=''/>"/>
      </div>
      <div class="col-md-2">
        <label class="form-label">Chicks Amount</label>
        <input type="number" name="chicksAmount" class="form-control" step="0.01"
          value="<c:out value='${editTripDetails.chicksAmount}' default=''/>"/>
      </div>
      <div class="col-md-2">
        <label class="form-label">Expenses</label>
        <input type="number" name="expenses" class="form-control" step="0.01"
          value="<c:out value='${editTripDetails.expenses}' default=''/>"/>
      </div>
      <div class="col-md-12 text-end mt-3">
        <c:choose>
          <c:when test="${not empty editTripDetails}">
            <button type="submit" class="btn btn-primary px-4">Update</button>
          </c:when>
          <c:otherwise>
            <button type="submit" class="btn btn-primary px-4">Save</button>
          </c:otherwise>
        </c:choose>
        <button type="reset" class="btn btn-secondary ms-2 px-4">Clear</button>
      </div>
    </div>
  </form>
  <div class="mb-3">
    <form method="get" action="${pageContext.request.contextPath}/trip-details" class="row g-2 align-items-end">
      <div class="col-auto">
        <label for="monthSelect" class="form-label mb-0">Month</label>
        <select id="monthSelect" name="month" class="form-select">
          <option value="">All</option>
          <c:forEach var="m" begin="1" end="12">
            <option value="${m}" <c:if test="${selectedMonth == m}">selected</c:if>>${m}</option>
          </c:forEach>
        </select>
      </div>
      <div class="col-auto">
        <label for="yearSelect" class="form-label mb-0">Year</label>
        <select id="yearSelect" name="year" class="form-select">
          <option value="">All</option>
          <c:forEach var="y" begin="2020" end="${currentYear}">
            <option value="${y}" <c:if test="${selectedYear == y}">selected</c:if>>${y}</option>
          </c:forEach>
        </select>
      </div>
      <div class="col-auto">
        <button type="submit" class="btn btn-outline-primary">Search</button>
      </div>
    </form>
  </div>
  <div class="custom-table-box">
    <table class="table table-bordered table-hover bg-white shadow-sm">
      <thead class="table-dark">
        <tr>
          <th>Trip Number</th><th>Driver</th><th>Co-Driver</th><th>Van</th><th>Start Date</th><th>End Date</th><th>Loading Point</th><th>Fuel Cost</th><th>Fuel Bill No.</th><th>Dead Chicks</th><th>Dead Chicks Weight</th><th>Total Chicks Weight</th><th>Chicks Amount</th><th>Expenses</th><th>Action</th>
        </tr>
      </thead>
      <tbody>
        <c:forEach var="t" items="${tripDetailsList}">
          <tr>
            <td>${t.tripNumber}</td>
            <td><c:out value="${t.driver != null ? t.driver.name : ''}"/></td>
            <td><c:out value="${t.codriver != null ? t.codriver.name : ''}"/></td>
            <td><c:out value="${t.van != null ? t.van.vehicleNumber : ''}"/></td>
            <td>${t.startDate}</td>
            <td>${t.endDate}</td>
            <td>${t.loadingPoint}</td>
            <td>${t.fuelCost}</td>
            <td>${t.fuelBillNumber}</td>
            <td>${t.deadChicks}</td>
            <td>${t.deadChicksWeight}</td>
            <td>${t.totalChicksWeight}</td>
            <td>${t.chicksAmount}</td>
            <td>${t.expenses}</td>
            <td class="d-flex gap-1">
              <a href="${pageContext.request.contextPath}/trip-details/delete/${t.tripNumber}" class="btn btn-sm btn-outline-danger p-1" onclick="return confirm('Delete this trip detail?');" title="Delete">
                <i class="bi bi-trash"></i>
              </a>
              <a href="${pageContext.request.contextPath}/trip-details/edit/${t.tripNumber}" class="btn btn-sm btn-outline-primary p-1" title="Edit">
                <i class="bi bi-pencil"></i>
              </a>
            </td>
          </tr>
        </c:forEach>
      </tbody>
    </table>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  var tripNumberInput = document.getElementById('tripNumberInput');
  // Only auto-increment trip number if not editing
  var isEdit = Boolean(document.querySelector('[name="editTripDetails"]')) || tripNumberInput.readOnly;
  if (!isEdit && (!tripNumberInput.value || tripNumberInput.value === '')) {
    fetch('${pageContext.request.contextPath}/trip-details/latest-trip-number')
      .then(r => r.json())
      .then(num => {
        tripNumberInput.value = (parseInt(num, 10) + 1);
      })
      .catch(() => { tripNumberInput.value = 1; });
  }
});
</script>
</body>
</html>