package com.poultry.controller;

import com.poultry.model.Customer;
import com.poultry.service.CustomerService;
import com.poultry.service.EntryService;
import com.poultry.model.Entry;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.*;

import javax.servlet.http.HttpSession;
import java.util.HashMap;
import java.util.Map;

@Controller
@RequestMapping("/customers")
public class CustomerController {

    @Autowired private CustomerService customerService;
    @Autowired private EntryService entryService;

    @GetMapping
    public String list(Model model, HttpSession session) {
        if (session.getAttribute("loggedInUser") == null) {
            return "redirect:/login";
        }
        java.util.List<Customer> customers = customerService.findAll();
        for (Customer c : customers) {
            double sum = 0.0;
            for (Entry e : entryService.findByCustomer(c)) {
                Double balance = e.getBalanceAmount();
                if (balance != null) sum += balance;
            }
            c.setOutstandingAmount(sum);
            customerService.save(c);
        }
        model.addAttribute("customers", customers);
        return "customers";
    }

    @PostMapping("/save")
    public String saveOrUpdate(@ModelAttribute Customer c, HttpSession session) {
        if (session.getAttribute("loggedInUser") == null) {
            return "redirect:/login";
        }
        customerService.save(c);
        return "redirect:/customers";
    }

    @GetMapping("/delete/{id}")
    public String delete(@PathVariable Long id, HttpSession session) {
        if (session.getAttribute("loggedInUser") == null) {
            return "redirect:/login";
        }
        customerService.delete(id);
        return "redirect:/customers";
    }
}