<%@ page contentType="text/html; charset=UTF-8" pageEncoding="UTF-8" %>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%@ include file="nav.jsp" %>
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8"/>
  <title>Manage Users</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>
</head>
<body class="bg-light">
<div class="container mt-4">

<!--  <div class="d-flex justify-content-start mb-3">
    <a href="${pageContext.request.contextPath}/dashboard" class="btn btn-outline-secondary">
      <i class="bi bi-arrow-left"></i> Back
    </a>
  </div>-->

  <h2 class="mb-3">Manage Users</h2>

  <!-- Add -->
  <form action="${pageContext.request.contextPath}/users/save" method="post"
        class="card p-4 mb-4 shadow-sm bg-white"
        onsubmit="return validatePasswordMatch(this, false);">
    <div class="row g-3">
      <div class="col-md-4">
        <label class="form-label">Username</label>
        <input type="text" name="username" class="form-control" required/>
      </div>
      <div class="col-md-4">
        <label class="form-label">Email</label>
        <input type="email" name="email" class="form-control" required
               pattern="^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[A-Za-z]{2,}$"
               title="Enter a valid email"/>
      </div>
      <div class="col-md-4">
        <label class="form-label">Role</label>
        <select name="role" class="form-select" required>
          <option value="">Select Role</option>
          <option value="Admin">Admin</option>
          <option value="Staff">Staff</option>
        </select>
      </div>
      <div class="col-md-4">
        <label class="form-label">Password</label>
        <div class="input-group">
          <input type="password" id="password" name="password" class="form-control" required
                 pattern="^(?=.*[A-Za-z])(?=.*[0-9])(?=.*[@$!%*?&])[A-Za-z0-9@$!%*?&]{6,}$"
                 title="Min 6 chars, include letters, numbers & one special (@$!%*?&)"/>
          <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('password', this)">
            <i class="bi bi-eye"></i>
          </button>
        </div>
      </div>
      <div class="col-md-4">
        <label class="form-label">Confirm Password</label>
        <div class="input-group">
          <input type="password" id="confirmPassword" name="confirmPassword" class="form-control" required/>
          <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('confirmPassword', this)">
            <i class="bi bi-eye"></i>
          </button>
        </div>
        <small id="addPwdMismatch" class="text-danger d-none">Passwords do not match</small>
      </div>
      <div class="col-md-12 text-end">
        <button type="submit" class="btn btn-primary">Save User</button>
        <button type="reset" class="btn btn-secondary ms-2">Clear</button>
      </div>
    </div>
  </form>

  <!-- Table -->
  <table class="table table-bordered table-hover bg-white shadow-sm">
    <thead class="table-dark"><tr>
      <th>ID</th><th>Username</th><th>Email</th><th>Role</th><th>Action</th>
    </tr></thead>
    <tbody>
      <c:forEach var="user" items="${users}">
        <tr>
          <td>${user.id}</td>
          <td>${user.username}</td>
          <td>${user.email}</td>
          <td>${user.role}</td>
          <td class="d-flex gap-2">
            <button class="btn btn-info btn-sm" onclick="viewUser('${user.username}','${user.email}','${user.role}')">View</button>
            <button class="btn btn-warning btn-sm" onclick="editUser('${user.id}','${user.username}','${user.email}','${user.role}')">Edit</button>
            <a class="btn btn-danger btn-sm" href="${pageContext.request.contextPath}/users/delete/${user.id}"
               onclick="return confirm('Delete this user?');">Delete</a>
          </td>
        </tr>
      </c:forEach>
    </tbody>
  </table>
</div>

<!-- Edit Modal -->
<div class="modal fade" id="editModal" tabindex="-1"><div class="modal-dialog">
  <form class="modal-content" action="${pageContext.request.contextPath}/users/update" method="post"
        onsubmit="return validatePasswordMatch(this, true);">
    <div class="modal-header"><h5 class="modal-title">Edit User</h5>
      <button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
    <div class="modal-body row g-3 px-3">
      <input type="hidden" id="editId" name="id">
      <div class="col-12"><label>Username</label>
        <input id="editUsername" name="username" class="form-control" required/></div>
      <div class="col-12"><label>Email</label>
        <input id="editEmail" name="email" class="form-control" required
               pattern="^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[A-Za-z]{2,}$"/></div>
      <div class="col-12"><label>Role</label>
        <select id="editRole" name="role" class="form-select" required>
          <option value="Admin">Admin</option><option value="Staff">Staff</option>
        </select></div>
      <div class="col-12"><label>New Password (optional)</label>
        <div class="input-group">
          <input type="password" id="editPassword" name="password" class="form-control"
                 pattern="^(?=.*[A-Za-z])(?=.*[0-9])(?=.*[@$!%*?&])[A-Za-z0-9@$!%*?&]{6,}$"
                 title="Min 6 chars, include letters, numbers & one special (@$!%*?&)" />
          <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('editPassword', this)">
            <i class="bi bi-eye"></i>
          </button>
        </div>
        <small class="text-muted">Leave blank to keep current password</small>
      </div>
      <div class="col-12"><label>Confirm New Password</label>
        <div class="input-group">
          <input type="password" id="editConfirmPassword" name="confirmPassword" class="form-control"/>
          <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('editConfirmPassword', this)">
            <i class="bi bi-eye"></i>
          </button>
        </div>
        <small id="editPwdMismatch" class="text-danger d-none">Passwords do not match</small>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-success" type="submit">Update</button>
      <button class="btn btn-secondary" type="button" data-bs-dismiss="modal">Close</button>
    </div>
  </form>
</div></div>

<!-- View Modal -->
<div class="modal fade" id="viewModal" tabindex="-1"><div class="modal-dialog">
  <div class="modal-content p-3">
    <div class="modal-header"><h5 class="modal-title">User Details</h5>
      <button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
    <div class="modal-body">
      <p><strong>Username:</strong> <span id="viewUsername"></span></p>
      <p><strong>Email:</strong> <span id="viewEmail"></span></p>
      <p><strong>Role:</strong> <span id="viewRole"></span></p>
    </div>
  </div>
</div></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  function togglePassword(id, btn){
    const el=document.getElementById(id); const icon=btn.querySelector('i');
    if(el.type==='password'){ el.type='text'; icon.classList.replace('bi-eye','bi-eye-slash'); }
    else { el.type='password'; icon.classList.replace('bi-eye-slash','bi-eye'); }
  }
  function viewUser(u,e,r){ document.getElementById('viewUsername').innerText=u;
    document.getElementById('viewEmail').innerText=e; document.getElementById('viewRole').innerText=r;
    new bootstrap.Modal(document.getElementById('viewModal')).show(); }
  function editUser(id,u,e,r){ document.getElementById('editId').value=id;
    document.getElementById('editUsername').value=u; document.getElementById('editEmail').value=e;
    document.getElementById('editRole').value=r; document.getElementById('editPassword').value='';
    document.getElementById('editConfirmPassword').value='';
    new bootstrap.Modal(document.getElementById('editModal')).show(); }
  function validatePasswordMatch(form,isEdit){
    const p=form.querySelector('input[name="password"]')?.value||'';
    const c=form.querySelector('input[name="confirmPassword"]')?.value||'';
    if(isEdit && p==='' && c==='') return true;
    const ok=(p===c);
    const msg=form.querySelector(isEdit?'#editPwdMismatch':'#addPwdMismatch');
    if(msg) msg.classList.toggle('d-none', ok);
    if(!ok) { form.querySelector('input[name="confirmPassword"]').focus(); }
    return ok;
  }
</script>
</body>
</html>