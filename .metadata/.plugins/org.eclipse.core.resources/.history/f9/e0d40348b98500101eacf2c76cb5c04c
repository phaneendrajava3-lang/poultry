<%@ page contentType="text/html; charset=UTF-8" pageEncoding="UTF-8" %>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8"/>
  <title>Trip Details</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet"/>
</head>
<body class="bg-light">
<%@ include file="nav.jsp" %>
<div class="container mt-4">
  <h2 class="mb-3">Trip Details</h2>
  <form action="${pageContext.request.contextPath}/trip-details/save" method="post" class="card p-4 mb-4 shadow-sm bg-white">
    <div class="row g-3">
      <div class="col-md-2">
        <label class="form-label">Trip Number</label>
        <input type="number" name="tripNumber" class="form-control" required/>
      </div>
      <div class="col-md-2">
        <label class="form-label">Driver</label>
        <select name="driver.id" class="form-select" required>
          <option value="">-- Select Driver --</option>
          <c:forEach var="d" items="${drivers}">
            <option value="${d.id}">${d.name}</option>
          </c:forEach>
        </select>
      </div>
      <div class="col-md-2">
        <label class="form-label">Co-Driver</label>
        <select name="codriver.id" class="form-select">
          <option value="">-- Select Co-Driver --</option>
          <c:forEach var="d" items="${drivers}">
            <option value="${d.id}">${d.name}</option>
          </c:forEach>
        </select>
      </div>
      <div class="col-md-2">
        <label class="form-label">Van</label>
        <select name="van.id" class="form-select" required>
          <option value="">-- Select Van --</option>
          <c:forEach var="v" items="${vans}">
            <option value="${v.id}">${v.vehicleNumber}</option>
          </c:forEach>
        </select>
      </div>
      <div class="col-md-2">
        <label class="form-label">Start Date</label>
        <input type="date" name="startDate" class="form-control" required/>
      </div>
      <div class="col-md-2">
        <label class="form-label">End Date</label>
        <input type="date" name="endDate" class="form-control" required/>
      </div>
      <div class="col-md-2">
        <label class="form-label">Loading Point</label>
        <input type="text" name="loadingPoint" class="form-control"/>
      </div>
      <div class="col-md-2">
        <label class="form-label">Fuel Cost</label>
        <input type="number" name="fuelCost" class="form-control" step="0.01"/>
      </div>
      <div class="col-md-2">
        <label class="form-label">Fuel Bill No.</label>
        <input type="text" name="fuelBillNumber" class="form-control"/>
      </div>
      <div class="col-md-2">
        <label class="form-label">Dead Chicks</label>
        <input type="number" name="deadChicks" class="form-control"/>
      </div>
      <div class="col-md-2">
        <label class="form-label">Dead Chicks Weight</label>
        <input type="number" name="deadChicksWeight" class="form-control" step="0.01"/>
      </div>
      <div class="col-md-2">
        <label class="form-label">Total Chicks Weight</label>
        <input type="number" name="totalChicksWeight" class="form-control" step="0.01"/>
      </div>
      <div class="col-md-2">
        <label class="form-label">Chicks Amount</label>
        <input type="number" name="chicksAmount" class="form-control" step="0.01"/>
      </div>
      <div class="col-md-2">
        <label class="form-label">Expenses</label>
        <input type="number" name="expenses" class="form-control" step="0.01"/>
      </div>
      <div class="col-md-12 text-end mt-3">
        <button type="submit" class="btn btn-primary px-4">Save</button>
        <button type="reset" class="btn btn-secondary ms-2 px-4">Clear</button>
      </div>
    </div>
  </form>

  <!-- Filters -->
  <div class="row mb-3">
    <div class="col-md-3">
      <input id="filter-customer" class="form-control" placeholder="Filter by customer name" />
    </div>
    <div class="col-md-3">
      <input id="filter-start" type="date" class="form-control" placeholder="Start date" />
    </div>
    <div class="col-md-3">
      <input id="filter-end" type="date" class="form-control" placeholder="End date" />
    </div>
    <div class="col-md-3">
      <button id="filter-btn" class="btn btn-primary w-100" type="button">Search</button>
    </div>
  </div>

  <!-- Table -->
  <table class="table table-bordered table-hover bg-white shadow-sm" id="tripTable">
    <thead class="table-dark">
      <tr>
        <th>Trip Number</th><th>Driver</th><th>Co-Driver</th><th>Van</th><th>Start Date</th><th>End Date</th><th>Loading Point</th><th>Fuel Cost</th><th>Fuel Bill No.</th><th>Dead Chicks</th><th>Dead Chicks Weight</th><th>Total Chicks Weight</th><th>Chicks Amount</th><th>Expenses</th><th>Action</th>
      </tr>
    </thead>
    <tbody>
      <c:forEach var="t" items="${tripDetailsList}">
        <tr>
          <td>${t.tripNumber}</td>
          <td><c:out value="${t.driver != null ? t.driver.name : ''}"/></td>
          <td><c:out value="${t.codriver != null ? t.codriver.name : ''}"/></td>
          <td><c:out value="${t.van != null ? t.van.vehicleNumber : ''}"/></td>
          <td>${t.startDate}</td>
          <td>${t.endDate}</td>
          <td>${t.loadingPoint}</td>
          <td>${t.fuelCost}</td>
          <td>${t.fuelBillNumber}</td>
          <td>${t.deadChicks}</td>
          <td>${t.deadChicksWeight}</td>
          <td>${t.totalChicksWeight}</td>
          <td>${t.chicksAmount}</td>
          <td>${t.expenses}</td>
          <td class="d-flex gap-1">
            <a href="${pageContext.request.contextPath}/trip-details/delete/${t.id}" class="btn btn-sm btn-outline-danger p-1" onclick="return confirm('Delete this trip detail?');" title="Delete">
              <i class="bi bi-trash"></i>
            </a>
          </td>
        </tr>
      </c:forEach>
    </tbody>
  </table>

  <!-- Filtered Table (hidden by default) -->
  <table class="table table-bordered table-hover bg-white shadow-sm" id="filteredTripTable" style="display:none;">
    <thead class="table-dark">
      <tr>
        <th>Trip Number</th><th>Driver</th><th>Co-Driver</th><th>Van</th><th>Start Date</th><th>End Date</th><th>Loading Point</th><th>Fuel Cost</th><th>Fuel Bill No.</th><th>Dead Chicks</th><th>Dead Chicks Weight</th><th>Total Chicks Weight</th><th>Chicks Amount</th><th>Expenses</th><th>Action</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const filterCustomer = document.getElementById('filter-customer');
  const filterStart = document.getElementById('filter-start');
  const filterEnd = document.getElementById('filter-end');
  const filterBtn = document.getElementById('filter-btn');
  const tripTable = document.getElementById('tripTable');
  const filteredTripTable = document.getElementById('filteredTripTable');
  const filteredTbody = filteredTripTable.querySelector('tbody');

  function filterTrips() {
    const customer = filterCustomer.value.trim();
    const start = filterStart.value;
    const end = filterEnd.value;
    if (!customer && !start && !end) {
      tripTable.style.display = '';
      filteredTripTable.style.display = 'none';
      return;
    }
    let params = [];
    if (customer) params.push('customerName=' + encodeURIComponent(customer));
    if (start) params.push('startDate=' + encodeURIComponent(start));
    if (end) params.push('endDate=' + encodeURIComponent(end));
    const url = `${contextPath}/trip-details/filter` + (params.length ? '?' + params.join('&') : '');
    fetch(url)
      .then(r => r.json())
      .then(data => {
        if (!Array.isArray(data) || data.length === 0) {
          filteredTbody.innerHTML = '<tr><td colspan="15" class="text-center">No data found</td></tr>';
          tripTable.style.display = 'none';
          filteredTripTable.style.display = '';
          return;
        }
        filteredTbody.innerHTML = '';
        data.forEach(t => {
          const tr = document.createElement('tr');
          const td = v => { const td = document.createElement('td'); td.textContent = v ?? ''; return td; };
          tr.appendChild(td(t.tripNumber));
          tr.appendChild(td(t.driver && t.driver.name));
          tr.appendChild(td(t.codriver && t.codriver.name));
          tr.appendChild(td(t.van && t.van.vehicleNumber));
          tr.appendChild(td(t.startDate));
          tr.appendChild(td(t.endDate));
          tr.appendChild(td(t.loadingPoint));
          tr.appendChild(td(t.fuelCost));
          tr.appendChild(td(t.fuelBillNumber));
          tr.appendChild(td(t.deadChicks));
          tr.appendChild(td(t.deadChicksWeight));
          tr.appendChild(td(t.totalChicksWeight));
          tr.appendChild(td(t.chicksAmount));
          tr.appendChild(td(t.expenses));
          // Action
          const tdAction = document.createElement('td');
          tdAction.className = 'd-flex gap-1';
          const del = document.createElement('a');
          del.className = 'btn btn-sm btn-outline-danger p-1';
          del.href = `${contextPath}/trip-details/delete/${t.id}`;
          del.title = 'Delete';
          del.onclick = function() { return confirm('Delete this trip detail?'); };
          del.innerHTML = '<i class="bi bi-trash"></i>';
          tdAction.appendChild(del);
          tr.appendChild(tdAction);
          filteredTbody.appendChild(tr);
        });
        tripTable.style.display = 'none';
        filteredTripTable.style.display = '';
      })
      .catch(() => {
        filteredTbody.innerHTML = '<tr><td colspan="15" class="text-center text-danger">Error fetching data</td></tr>';
        tripTable.style.display = 'none';
        filteredTripTable.style.display = '';
      });
  }
  filterBtn.addEventListener('click', filterTrips);
  filterCustomer.addEventListener('input', filterTrips);
  filterStart.addEventListener('change', filterTrips);
  filterEnd.addEventListener('change', filterTrips);
});
</script>
</body>
</html>